server_url="http://46.16.74.57/geoserver";var ll_lat=null;var ll_lon=null;var ur_lat=null;var ur_lon=null;var lon=null;var lat=null;var bbox_west=null;var bbox_east=null;var bbox_south=null;var bbox_north=null;var big_box=null;var chosen_parameter="";var chosen_date_period="";var current_unit="";var chosen_time="";var zoom_in=false;var zoom_out=false;var map,wms,box_layer,boundingbox_layer,station_layer,station_self,rectangle_control,station_control,time_array;
var request_results={};var window_height=window.availHeight;var window_width=window.availWidth;var loading_average=false;var loading_aoi=false;var date_available=true;var send_request_counter=0;var get_request_counter=0;var map_width=0;var map_height=0;var feature_counter=0;var feature_requests=[];var response;var paralist=["tur","chl","hab","sec","z90","cdm","abs","soa","sia","sst"];var paraindex=[0,1,2,3,4,5,6,7,8,9];
var periodlist=["daily","mmean","dmean","monthly"];var periodindex=[0,3,1,2];var osm=true;var range_daily=730;var range_monthly=24;var chart_results;function init(){if(osm){map=new OpenLayers.Map("map",{eventListeners:{moveend:map_change_event,click:click_event},controls:[new OpenLayers.Control.Navigation(),new OpenLayers.Control.ArgParser(),new OpenLayers.Control.Attribution({div:document.getElementById("bottom_panel_attribution")}),new OpenLayers.Control.ScaleLine({div:document.getElementById("bottom_panel_scale")})],projection:"EPSG:900913",zoom:3,wrapDateLine:true});
map.addControl(new OpenLayers.Control.MousePosition({div:document.getElementById("bottom_panel_position"),displayProjection:"EPSG:4326"}))}else{map=new OpenLayers.Map("map",{eventListeners:{moveend:map_change_event,click:click_event},controls:[new OpenLayers.Control.Navigation(),new OpenLayers.Control.ArgParser(),new OpenLayers.Control.Attribution({div:document.getElementById("bottom_panel_attribution")}),new OpenLayers.Control.ScaleLine({div:document.getElementById("bottom_panel_scale")})],projection:"EPSG:4326"});
map.addControl(new OpenLayers.Control.MousePosition({div:document.getElementById("bottom_panel_position")}))}var c=OpenLayers.Layer.Bing.prototype.serverResolutions.slice(2,15);var f=new OpenLayers.Layer.WMS("Blue Marble",server_url+"/wms",{layers:"eomap:bluemarble_250m"},{attribution:'<span>Base map: <a href="http://www.unearthedoutdoors.net/global_data/true_marble/download" target="_blank">True Marble</a> 250m &copy; 2003-2007 Unearthed Outdoors, LLC. All rights reserved.</span>'});
var e=new OpenLayers.Layer.OSM("OpenStreetMap","http://tile.geofabrik.de/6eb3a27d04939aca6eee2e46acd66141/${z}/${x}/${y}.png",{zoomOffset:2,resolutions:c,isBaseLayer:true,attribution:'Base map: Maps &copy<a href="http://www.geofabrik.de/" target="_blank">Geofabrik</a>, Data &copy<a href="http://www.openstreetmap.org/copyright/en" target="_blank"> OpenStreetMap contributors</a>'});var d="AsiNxQT_XX8YPjCOzp2YcezDfXOvRbtVXXSeNk1-92t74BRI1XYPtz0vNAcJ3Fo7";
var b=new OpenLayers.Layer.Bing({name:"Bing Road",key:d,type:"Road",isBaseLayer:true,resolutions:c,zoomOffset:2});var g=new OpenLayers.Layer.Bing({name:"Bing Aerial",key:d,type:"AerialWithLabels",isBaseLayer:true,resolutions:c,zoomOffset:2,wrapDateLine:true});var j=new OpenLayers.Layer.Bing({name:"Bing Earth",key:d,type:"Aerial",isBaseLayer:true,resolutions:c,zoomOffset:2});box_layer=new OpenLayers.Layer.Vector("Selected Area",{displayInLayerSwitcher:false});
station_layer=new OpenLayers.Layer.Vector("Station",{styleMap:new OpenLayers.StyleMap({"default":{externalGraphic:"pic/station.png",graphicYOffset:-43,graphicWidth:28,graphicHeight:45}}),displayInLayerSwitcher:false});boundingbox_layer=new OpenLayers.Layer.Vector("Bounding Box",{styleMap:new OpenLayers.StyleMap({"default":{strokeWidth:3,strokeColor:"#00558C"}}),displayInLayerSwitcher:false});rectangle_control=new OpenLayers.Control.DrawFeature(box_layer,OpenLayers.Handler.RegularPolygon,{handlerOptions:{sides:4,irregular:true},featureAdded:set_bbox,multi:false});
station_control=new OpenLayers.Control.DrawFeature(station_layer,OpenLayers.Handler.Point,{featureAdded:set_station,multi:false});select_control=new OpenLayers.Control.SelectFeature(boundingbox_layer,{hover:true,higlightonly:false,clickFeature:function(k){console.log(this.layer.selectedFeatures[0].data.fid);aname=this.layer.selectedFeatures[0].data.fid;element=$('#area_list option[value="'+aname+'"]');
element.prop("selected",true);update_region(aname)}});layer_switcher=new OpenLayers.Control.LayerSwitcher();if(osm){map.addLayers([g,j,b,e,station_layer,box_layer,boundingbox_layer])}else{map.addLayers([f,station_layer,box_layer,boundingbox_layer])}map.addControl(layer_switcher);map.addControl(rectangle_control);map.addControl(station_control);station_control.activate();map.addControl(select_control);
select_control.activate();mapcenter=new OpenLayers.LonLat(center_lon,center_lat);if(osm){mapcenter.transform("EPSG:4326","EPSG:900913")}map.setCenter(mapcenter,center_zoom);enable_buttons(true);chosen_parameter=$("input[name=parameter]:checked").val();chosen_date_period=$("input[name=date_period]:checked").val();current_unit=get_unit(chosen_parameter);OpenLayers.ProxyHost="/cgi-bin/proxy.cgi?url=";
get_capabilities();load_date_and_bbox(true);getRegions();update_region(chosen_region);if(station_lon&&station_lat){var h=new OpenLayers.LonLat(station_lon,station_lat);if(osm){h.transform("EPSG:4326","EPSG:900913")}lon=h.lon;lat=h.lat;get_feature();if(station_layer.features.length>1){station_layer.removeFeatures([station_layer.features[station_layer.features.length-2]])}station_layer.addFeatures([new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(lon,lat))]);
map.raiseLayer(station_layer,2)}}function check_layer_available(b){return b&&b.parameters&&chosen_parameter in b.parameters}function get_layer_name(b){if(b&&b.parameters&&chosen_parameter in b.parameters){if(!b.parameters[chosen_parameter].period_available){return b.parameters[chosen_parameter].all}else{if(chosen_date_period in b.parameters[chosen_parameter]){return b.parameters[chosen_parameter][chosen_date_period]
}}}return null}function map_change_event(b){if(chosen_parameter){getDates();$.each(areas,function(c,d){calculate_display_area(d);update_map(d)})}}function click_event(b){if(zoom_in){map.zoomTo(map.getZoom()+1,b.xy)}else{if(zoom_out){map.zoomTo(map.getZoom()-1,b.xy)}}}function calculate_display_area(c){var b=map.getExtent();c.display_area={ll_lon:!c.bounds||b.left>c.bounds.west?b.left:c.bounds.west,ll_lat:!c.bounds||b.bottom>c.bounds.south?b.bottom:c.bounds.south,ur_lon:!c.bounds||b.right<c.bounds.east?b.right:c.bounds.east,ur_lat:!c.bounds||b.top<c.bounds.north?b.top:c.bounds.north}
}function get_capabilities(){response=OpenLayers.Request.GET({url:server_url+"/ows/",async:false,params:{SERVICE:"WMS",VERSION:"1.3.0",REQUEST:"GetCapabilities",INFO_FORMAT:"application/xml"},failure:function(b){location.href="http://eoapp-maintenance.eomap.com/"}})}function load_date_and_bbox(d){request=response;select=document.getElementById("date_list");select.innerHTML="";boundingbox_layer.removeAllFeatures();
var b=request.responseText;var c=0;$.each(areas,function(o,g){g.dates=null;var s=get_layer_name(g);if(!s||!g.parameters[chosen_parameter].display_eval()){return}index_layer=b.search("<Name>"+s+"</Name>");if(index_layer<0){console.log("Layer '"+s+"' not found.")}else{var h=b.substring(index_layer);h=h.substring(0,h.search("</Layer>"));bbox_index=h.search("<EX_GeographicBoundingBox>")+"<EX_GeographicBoundingBox>".length;
if(bbox_index>0){var f=h.substring(bbox_index,h.search("</EX_GeographicBoundingBox>"));g.bounds={west:f.substring(f.search("<westBoundLongitude>")+"<westBoundLongitude>".length,f.search("</westBoundLongitude>")),east:f.substring(f.search("<eastBoundLongitude>")+"<eastBoundLongitude>".length,f.search("</eastBoundLongitude>")),south:f.substring(f.search("<southBoundLatitude>")+"<southBoundLatitude>".length,f.search("</southBoundLatitude>")),north:f.substring(f.search("<northBoundLatitude>")+"<northBoundLatitude>".length,f.search("</northBoundLatitude>"))};
if(osm){var q=new OpenLayers.Bounds([g.bounds.west,g.bounds.south,g.bounds.east,g.bounds.north]);q.transform("EPSG:4326","EPSG:900913");g.bounds={west:q.left,east:q.right,south:q.bottom,north:q.top}}var p=new OpenLayers.Geometry.Point(g.bounds.west,g.bounds.north);var k=new OpenLayers.Geometry.Point(g.bounds.east,g.bounds.north);var n=new OpenLayers.Geometry.Point(g.bounds.east,g.bounds.south);var r=new OpenLayers.Geometry.Point(g.bounds.west,g.bounds.south);
calculate_display_area(g);boundingbox_layer.addFeatures([new OpenLayers.Feature.Vector(new OpenLayers.Geometry.LineString([p,k,n,r,p]),{fid:g.name})])}if(g.group){g.date_available=false;groupmembers=g.parameters[chosen_parameter][chosen_date_period+"group"];var e=[];for(var u=0;u<groupmembers.length;u++){member=groupmembers[u];index_member=b.search("<Name>"+member+"</Name>");var m=b.substring(index_member);
m=m.substring(0,m.search("</Layer>"));if(m.search('<Dimension name="time" default="current" units="ISO8601">')>-1){g.date_available=true;var l=m.search('<Dimension name="time" default="current" units="ISO8601">')+'<Dimension name="time" default="current" units="ISO8601">'.length;if(l>0){var j=m.substring(l,m.search("</Dimension>"));e=e.concat(j.split(","));c+=e.length}}}if(e.length>0){e.sort();g.dates=e.filter(function(v,w){return e.indexOf(v)==w
})}}else{if(h.search('<Dimension name="time" default="current" units="ISO8601">')==-1){g.date_available=false}else{g.date_available=true;var l=h.search('<Dimension name="time" default="current" units="ISO8601">')+'<Dimension name="time" default="current" units="ISO8601">'.length;if(l>0){var j=h.substring(l,h.search("</Dimension>"));g.dates=j.split(",");c+=g.dates.length}}}}});if(c===0){chosen_date_period="all"
}getDates();$.each(areas,function(e,f){remove_last_layer(f.name);if(d&&chosen_region&&(f.name==chosen_region)){update_map(f)}});get_feature();return true}function getDates(){var d=false;$("#date_list").empty();var c=(chosen_date_period=="daily"||chosen_date_period=="dmean"||chosen_date_period=="mmean")?"dd-mm-yy ":"M yy";var g=[];var f=0;var e=null;var b="";$.each(areas,function(j,m){e=null;if(chosen_region&&m.name!=chosen_region){}else{if(m.dates&&areaVisible(m)){var l=0;
for(var k=m.dates.length-1;k>=0;k--){var h=new Date(m.dates[k]);var n=$.datepicker.formatDate(c,h);if(chosen_date_period=="daily"||chosen_date_period=="dmean"){n+=formatTime("HH:mm",h)}if(chosen_date_period=="monthly"){if(m.seasonal){n="Various Dates."}else{n=$.datepicker.formatDate("MM yy",h)}}if($.inArray(m.dates[k],g)<0){$("#date_list").append('<option value="'+m.dates[k]+'">'+n+"  "+m.name+"</option>");
if(!e||((chosen_date_period=="daily"||chosen_date_period=="dmean"||chosen_date_period=="mmean")&&h.getUTCDate()!=e.getUTCDate())||(chosen_date_period=="monthly"&&h.getUTCMonth()!=e.getUTCMonth())){e=h;l++}}if(!d&&chosen_time==m.dates[k]){$("#date_list option:last").prop("selected",true);d=true}}}}});$("#date_list").append(b);if($("#date_list option").length==0){$("#date_list").append("<option>No date available</option>")
}else{if(!d&&!chosen_time){chosen_time=$("#date_list option:first").val();$("#date_list option:first").prop("selected",true)}}if($("#date_list option").length>1){enableChart()}else{disableChart()}updateMapHeading()}function boundsVisible(c){var b=map.getExtent();return b.left<c.east&&b.right>c.west&&b.top>c.south&&b.bottom<c.north}function areaVisible(c){calculate_display_area(c);if(!c.bounds){return true
}var b=c.bounds;var g=c.display_area;var j=map.getExtent();var k=0;var e=0;count=0;if(j.left>b.west){count++}if(j.right<b.east){count++}if(j.top<b.north){count++}if(j.bottom>b.south){count++}if(count>=4){return true}var h=Math.abs(b.west-b.east)*Math.abs(b.north-b.south);var f=Math.abs(g.ll_lon-g.ur_lon)*Math.abs(g.ll_lat-g.ur_lat);var d=Math.abs(j.left-j.right)*Math.abs(j.top-j.bottom);k=f/h;e=f/d;
if(j.left<b.east&&j.right>b.west&&j.top>b.south&&j.bottom<b.north&&(k>0.4||e>0.3)){return true}else{return false}}function getRegions(){$("#area_list").empty();var b=[];$.each(areas,function(d,e){b[b.length]=e.country+" - "+e.name+" - ["+e.resolution+"]"});b.sort();for(var c=0;c<b.length;c++){$("#area_list").append('<option value="'+b[c].split(" - ")[1]+'">'+b[c]+"</option>");if(b[c].split(" - ")[1]==chosen_region){$("#area_list option:last").prop("selected",true)
}}}function update_region(c){chosen_region=c;var b;$("input[type=radio][name=parameter]").prop("checked",false);$("input[type=radio][name=parameter]").prop("disabled",false);$("input[type=radio][name=date_period]").prop("checked",false);$("input[type=radio][name=date_period]").prop("disabled",false);$("#date_list").prop("disabled",false);$.each(areas,function(e,h){var g=false;var j=false;if(h.name==chosen_region){b=h;
if(b.date){chosen_time=b.date+":00.000Z"}for(var f=0;f<paralist.length;f++){if(paralist[f] in h.parameters){if(!g){chosen_parameter=paralist[f];$("input[type=radio][name=parameter]").eq(paraindex[f]).prop("checked",true);g=true;if(h.parameters[chosen_parameter].palstyle){$("#legend").css("background-image","url(/pic/legend_"+chosen_parameter+"_"+h.parameters[chosen_parameter].palstyle+".png)")}else{$("#legend").css("background-image","url(/pic/legend_"+chosen_parameter+".png)")
}}}else{$("input[type=radio][name=parameter]").eq(paraindex[f]).prop("disabled",true)}}for(var f=0;f<periodlist.length;f++){if(periodlist[f] in h.parameters[chosen_parameter]){if(!j){$("input[type=radio][name=date_period]").eq(periodindex[f]).prop("checked",true);chosen_date_period=$("input[type=radio][name=date_period]:checked").val();j=true}}else{$("input[type=radio][name=date_period]").eq(periodindex[f]).prop("disabled",true)
}}}});current_unit=get_unit(chosen_parameter);load_date_and_bbox(true);if(b){if(chosen_date_period=="monthly"){console.log("Zoom To Mapcenter");map.setCenter(mapcenter,1)}else{console.log("Zoom To Extent");OLBounds=new OpenLayers.Bounds([b.bounds.west,b.bounds.south,b.bounds.east,b.bounds.north]);map.zoomToExtent(OLBounds)}}else{OLBounds=map.maxExtent;map.zoomToExtent(OLBounds)}if(b){if(b.station_lon&&b.station_lat){var d=new OpenLayers.LonLat(b.station_lon,b.station_lat);
if(osm){d.transform("EPSG:4326","EPSG:900913")}lon=d.lon;lat=d.lat;get_feature();if(station_layer.features.length>=1){station_layer.removeAllFeatures()}station_layer.addFeatures([new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(lon,lat))]);map.raiseLayer(station_layer,2)}}}function enable_buttons(d){var b;var c=[];var e=[];$("input[type=radio][name=parameter]").prop("disabled",true);$("input[type=radio][name=parameter]").prop("checked",false);
$("input[type=radio][name=date_period]").prop("disabled",true);$("input[type=radio][name=date_period]").prop("checked",false);$("#date_list").prop("disabled",false);$.each(areas,function(f,j){var h=false;var k=false;if(chosen_region&&j.name==chosen_region){b=j}if(areaVisible(j)){for(var g=0;g<paralist.length;g++){if(paralist[g] in j.parameters){$("input[type=radio][name=parameter]").eq(paraindex[g]).prop("disabled",false);
if(!(paraindex[g] in c)){c.push(paraindex[g])}if(b&&(b.name==j.name)&&d&&!h){chosen_parameter=paralist[g];$("input[type=radio][name=parameter]").eq(paraindex[g]).prop("checked",true);h=true;if(j.parameters[chosen_parameter].palstyle){$("#legend").css("background-image","url(/pic/legend_"+chosen_parameter+"_"+j.parameters[chosen_parameter].palstyle+".png)")}else{$("#legend").css("background-image","url(/pic/legend_"+chosen_parameter+".png)")
}}}}for(var g=0;g<periodlist.length;g++){if(j.parameters[chosen_parameter]&&j.parameters[chosen_parameter][periodlist[g]]){$("input[type=radio][name=date_period]").eq(periodindex[g]).prop("disabled",false);if(!(periodindex[g] in e)){e.push(periodindex[g])}if(b&&(b.name==j.name)&&d&&!k){$("input[type=radio][name=date_period]").eq(periodindex[g]).prop("checked",true);chosen_date_period=$("input[type=radio][name=date_period]:checked").val();
k=true}}}}});if(!b){$("input[type=radio][name=parameter]").eq(c[0]).prop("checked",true);chosen_parameter=$("input[type=radio][name=parameter]:checked").val();$("input[type=radio][name=date_period]").eq(e[0]).prop("checked",true);chosen_date_period=$("input[type=radio][name=date_period]:checked").val()}}function change_lat(b){try{lat=parseFloat(b.value);station_control.drawFeature(new OpenLayers.Geometry.Point(lon,lat))
}catch(c){alert("Invalid coordinates.")}}function change_lon(b){try{lon=parseFloat(b.value);station_control.drawFeature(new OpenLayers.Geometry.Point(lon,lat))}catch(c){alert("Invalid coordinates.")}}function update_map(d){var b=map.getLayersByName(d.name);if(b.length>0){remove_last_layer(d.name)}if(!get_layer_name(d)||!d.parameters[chosen_parameter].display_eval()){return}var c=load_layer(d);map.addLayer(c);
map.raiseLayer(station_layer,2)}function update_date(b){document.getElementById("value").innerHTML="---";document.getElementById("value_m").innerHTML="---";document.getElementById("average").innerHTML="---";document.getElementById("average_m").innerHTML="---";chosen_time=b.value=="No date available"?null:b.value;updateMapHeading();$.each(areas,function(c,d){if(chosen_region&&d.name==chosen_region){update_map(d)
}});get_feature()}function createUTCDate(b){year=b.split("-")[0];month=b.split("-")[1]-1;day=b.split("-")[2];return new Date(Date.UTC(year,month,day))}function update_parameter(d){document.getElementById("value").innerHTML="---";document.getElementById("value_m").innerHTML="---";document.getElementById("average").innerHTML="---";document.getElementById("average_m").innerHTML="---";chosen_parameter=d.value;
current_unit=get_unit(chosen_parameter);var b=false;$.each(areas,function(f,g){if(chosen_region&&g.name!=chosen_region){}else{if(areaVisible(g)&&check_layer_available(g)&&g.parameters[chosen_parameter].period_available){b=true}}});if(!b){$("input[type=radio][name=date_period]").prop("disabled",true);$("#date_list").prop("disabled",true);$("input[type=radio][name=date_period]").prop("checked",false);
chosen_date_period="all"}else{chosen_date_period_actual=$("input[type=radio][name=date_period]:checked").val();$("input[type=radio][name=date_period]").prop("disabled",true);$("#date_list").prop("disabled",false);$.each(areas,function(f,h){if(chosen_region&&h.name!=chosen_region){}else{if(areaVisible(h)){for(var g=0;g<periodlist.length;g++){if(h.parameters[chosen_parameter]&&(periodlist[g] in h.parameters[chosen_parameter])){$("input[type=radio][name=date_period]").eq(periodindex[g]).prop("disabled",false)
}}}}});if(chosen_date_period_actual=="daily"&&!($("input[type=radio][name=date_period]").eq(0).prop("disabled"))){$("input[type=radio][name=date_period]").eq(0).prop("checked",true)}else{if(chosen_date_period_actual=="dmean"&&!($("input[type=radio][name=date_period]").eq(1).prop("disabled"))){$("input[type=radio][name=date_period]").eq(1).prop("checked",true)}else{if(chosen_date_period_actual=="monthly"&&!($("input[type=radio][name=date_period]").eq(2).prop("disabled"))){$("input[type=radio][name=date_period]").eq(2).prop("checked",true)
}else{if(chosen_date_period_actual=="mmean"&&!($("input[type=radio][name=date_period]").eq(3).prop("disabled"))){$("input[type=radio][name=date_period]").eq(3).prop("checked",true)}else{var e=false;for(var c=0;c<periodlist.length;c++){if(!e&&!($("input[type=radio][name=date_period]").eq(periodindex[c]).prop("disabled"))){e=true;$("input[type=radio][name=date_period]").eq(periodindex[c]).prop("checked",true)
}}}}}}chosen_date_period=$("input[type=radio][name=date_period]:checked").val()}if(chosen_parameter=="owd"){disableChart()}else{enableChart()}load_date_and_bbox(true)}function set_bbox(e){var c=box_layer.features;while(c.length>1){box_layer.removeFeatures(c[0])}var d=e.geometry.getBounds();ll_lon=d.left;ll_lat=d.bottom;ur_lon=d.right;ur_lat=d.top;var b=load_layer();b.events.register("loadstart",null,function(f){set_loading_aoi()
});b.events.register("loadend",null,function(f){reset_loading_aoi()});remove_last_layer("Layer Image");map.addLayer(b);map.raiseLayer(station_layer,2);update_document()}function load_layer(e){var b=get_layer_name(e);if(!b||!e.parameters[chosen_parameter].display_eval()){return}if(chosen_parameter==="vis"&&e.name!=="Great Barrier Reef Shallow Water"){var d="visibility"}else{if(e.parameters[chosen_parameter].palstyle){var d=e.parameters[chosen_parameter].palstyle
}else{var d=""}}if(osm){var f=server_url+"/eomap/wms?SERVICE=WMS&LAYERS="+b+"&TRANSPARENT=true&FORMAT=image/png&VERSION=1.1.1&REQUEST=GetMap&STYLES="+d+"&SRS=EPSG:900913"}else{var f=server_url+"/eomap/wms?SERVICE=WMS&LAYERS="+b+"&TRANSPARENT=true&FORMAT=image/png&VERSION=1.1.1&REQUEST=GetMap&STYLES="+d+"&SRS=EPSG:4326"}var g=new OpenLayers.Bounds(e.display_area.ll_lon,e.display_area.ll_lat,e.display_area.ur_lon,e.display_area.ur_lat);
var c=g.getSize();f=f+"&WIDTH="+parseInt(map_width);f=f+"&HEIGHT="+parseInt(map_height);f=f+"&BBOX="+g.left+","+g.bottom+","+g.right+","+g.top;if(e.date_available){if(!chosen_time){f=f}else{f=f+"&TIME="+chosen_time}}if(osm){return new OpenLayers.Layer.Image(e.name,f,g,c,{isBaseLayer:false,maxResolution:20000,displayInLayerSwitcher:false})}else{return new OpenLayers.Layer.Image(e.name,f,g,c,{isBaseLayer:false})
}}function remove_last_layer(b){var c=map.getLayersByName(b);if(c.length>0){map.removeLayer(c[0])}}function update_document(){calculateArea()}function calculateArea(){area_b=Math.abs(((ur_lat-ll_lat)*111.3).toFixed(2));area_a=Math.abs(((ur_lon-ll_lon)*111.3).toFixed(2))}function activate_drag(){rectangle_control.deactivate();station_control.deactivate()}function activate_draw(){rectangle_control.activate();
station_control.deactivate()}function activate_stations(){rectangle_control.deactivate();station_control.activate()}function set_station(c){var b=c.geometry.getBounds().toArray();lon=b[0];lat=b[1];get_feature();if(station_layer.features.length>1){station_layer.removeFeatures([station_layer.features[station_layer.features.length-2]])}map.raiseLayer(station_layer,2)}function get_station_area(b,e){var d=null;
if(b===null||e===null){return null}var c=$("#date_list option:selected").text();$.each(areas,function(f,g){if(g.bounds&&chosen_parameter in g.parameters&&!g.parameters[chosen_parameter].ignore_station&&g.bounds.west<b&&g.bounds.east>b&&g.bounds.north>e&&g.bounds.south<e&&c.indexOf(g.name)>=0){d=g;return d}});return d}function abort_feature_requests(){for(var b=0;b<feature_requests.length;b++){feature_requests[b].abort()
}feature_requests=[];request_results={};calculate_averages()}function get_feature(){if(osm){var b="EPSG:900913"}else{var b="EPSG:4326"}var c=map.getPixelFromLonLat(new OpenLayers.LonLat(lon,lat));bbox_station=map.getExtent().toBBOX();width_station=map.size.w;height_station=map.size.h;x_station=c.x;y_station=c.y;station_area=get_station_area(lon,lat);abort_feature_requests();if(!station_area){return
}if(chosen_date_period=="monthly"){layers_to_query=[station_area.parameters[chosen_parameter][chosen_date_period],station_area.parameters.mas[chosen_date_period]]}else{layers_to_query=[station_area.parameters[chosen_parameter][chosen_date_period]]}OpenLayers.Request.GET({url:server_url+"/wms",params:{SERVICE:"WMS",VERSION:"1.1.1",REQUEST:"GetFeatureInfo",LAYERS:layers_to_query,STYLES:"",SRS:b,BBOX:bbox_station,TIME:chosen_time,WIDTH:width_station,HEIGHT:height_station,QUERY_LAYERS:layers_to_query,INFO_FORMAT:"application/json",FEATURE_COUNT:"10",X:x_station,Y:y_station},success:function(g){request_results={};
var l=JSON.parse(g.responseText);try{if(layers_to_query.length==1){if(l.features.length==1){var r=parseFloat(l.features[0].properties.GRAY_INDEX)}else{if(l.features.length==2){var q=parseFloat(l.features[0].properties.GRAY_INDEX);var o=parseFloat(l.features[1].properties.GRAY_INDEX);var r=Math.max(q,o)}else{throw""}}}else{wqvalues=[];timevalues=[];datevalues=[];for(var s=0;s<l.features.length;s++){if("Band2" in l.features[s].properties){datevalues.push(parseFloat(l.features[s].properties.GRAY_INDEX));
timevalues.push(parseFloat(l.features[s].properties.Band2))}else{wqvalues.push(parseFloat(l.features[s].properties.GRAY_INDEX))}}var r=Math.max.apply(null,wqvalues);var j=Math.max.apply(null,datevalues);var h=Math.max.apply(null,timevalues)}if(r==0||r==-9999){throw""}if(chosen_parameter=="vis"){r=turbidity_to_sd(r)}else{if(chosen_parameter=="hab"){r=decode_hab(r)}}if(chosen_date_period=="monthly"){if(chosen_parameter=="tur"){r=decode_tur_8bit(r)
}else{if(chosen_parameter=="chl"){r=decode_tur_8bit(r)}else{if(chosen_parameter=="abs"){r=decode_abs_8bit(r)}else{if(chosen_parameter=="soa"){r=decode_abs_8bit(r)}}}}}document.getElementById("value").innerHTML=r.toFixed(2)+" "+current_unit;document.getElementById("value_m").innerHTML=r.toFixed(2)+" "+current_unit;if(chosen_date_period=="monthly"){maskdate=get_date_from_jd(j)+" "+get_time(h)+" UTC";
document.getElementById("average").innerHTML=maskdate;document.getElementById("average_m").innerHTML=maskdate}else{document.getElementById("average").innerHTML=format_chosen_time(chosen_time);document.getElementById("average_m").innerHTML=format_chosen_time(chosen_time)}for(var k in station_area.dates){if(station_area.dates[k].search(chosen_time)==0){request_results[station_area.dates[k].substring(0,station_area.dates[k].search("T"))]=r;
break}}}catch(f){document.getElementById("value").innerHTML="no value";document.getElementById("value_m").innerHTML="no value";document.getElementById("average").innerHTML="no value";document.getElementById("average_m").innerHTML="no value"}var p=function(u){return OpenLayers.Request.GET({url:server_url+"/wms",params:{SERVICE:"WMS",VERSION:"1.1.1",REQUEST:"GetFeatureInfo",LAYERS:station_area.parameters[chosen_parameter][chosen_date_period],STYLES:"",SRS:b,BBOX:bbox_station,TIME:station_area.dates[u],WIDTH:width_station,HEIGHT:height_station,QUERY_LAYERS:station_area.parameters[chosen_parameter][chosen_date_period],INFO_FORMAT:"application/json",FEATURE_COUNT:"2",X:x_station,Y:y_station},success:function(y){var A=JSON.parse(y.responseText);
try{if(A.features.length==1){var z=parseFloat(A.features[0].properties.GRAY_INDEX)}else{if(A.features.length==2){var w=parseFloat(A.features[0].properties.GRAY_INDEX);var v=parseFloat(A.features[1].properties.GRAY_INDEX);var z=Math.max(w,v)}else{throw""}}if(z==0||z==-9999){throw""}if(chosen_parameter=="vis"){z=turbidity_to_sd(z)}else{if(chosen_parameter=="hab"){z=decode_hab(z)}}if(chosen_date_period=="monthly"){if(chosen_parameter=="tur"){z=decode_tur_8bit(z)
}else{if(chosen_parameter=="chl"){z=decode_tur_8bit(z)}else{if(chosen_parameter=="abs"){z=decode_abs_8bit(z)}else{if(chosen_parameter=="soa"){z=decode_abs_8bit(z)}}}}}request_results[station_area.dates[u].substring(0,station_area.dates[u].search("T"))]=z}catch(x){}calculate_averages()},failure:function(v){calculate_averages()}})};var e=new Date(chosen_time);var d=(chosen_date_period=="daily"||chosen_date_period=="dmean"||chosen_date_period=="mmean")?"yy-mm-dd":"yy-mm";
var m=(chosen_date_period=="daily"||chosen_date_period=="dmean"||chosen_date_period=="mmean")?range_daily:range_monthly;if(station_area.parameters[chosen_parameter].period_available){set_loading_average();if(chosen_date_period=="daily"||chosen_date_period=="dmean"||chosen_date_period=="mmean"){e.setMonth(11);e.setDate(31);e.setDate(e.getDate())}else{e.setMonth(11);e.setDate(1);e.setDate(e.getDate())
}for(var n=0;n<m;n++){for(var k=0;k<station_area.dates.length;k++){if(station_area.dates[k].search($.datepicker.formatDate(d,e))>=0){feature_requests.push(p(k));break}}if(chosen_date_period=="daily"||chosen_date_period=="dmean"||chosen_date_period=="mmean"){e.setDate(e.getDate()-1)}else{e.setMonth(e.getMonth()-1)}}}}})}function format_chosen_time(c){var e=c.substring(0,c.search("T")).split("-");var b=c.substring(c.search("T")+1,c.length).split(":");
return e[2]+"-"+e[1]+"-"+e[0]+" "+b[0]+":"+b[1]+" UTC"}function calculate_averages(){reset_loading_average();if(chosen_date_period=="monthly"){return}var c=0;var b;feature_counter=0;var d=0;if(chosen_time){avDate=createUTCDate(chosen_time.substring(0,chosen_time.search("T")));avDate.setUTCDate(avDate.getUTCDate()-30);for(b in request_results){if(createUTCDate(b)>=avDate){c=c+request_results[b];d++}feature_counter++
}}if(d==0){return}}function processChartData(g){var b=(chosen_date_period=="daily"||chosen_date_period=="dmean"||chosen_date_period=="mmean")?new Array(range_daily):new Array(range_monthly);var l=(chosen_date_period=="daily"||chosen_date_period=="dmean"||chosen_date_period=="mmean")?new Array(range_daily):new Array(range_monthly);var n=new Array();var c=new Array();var e=(chosen_date_period=="daily"||chosen_date_period=="dmean"||chosen_date_period=="mmean")?range_daily:range_monthly;
var m=(chosen_date_period=="daily"||chosen_date_period=="dmean"||chosen_date_period=="mmean")?"yy-mm-dd":"mm / yy";currentDate=new Date(chosen_time);if(chosen_date_period=="daily"||chosen_date_period=="dmean"||chosen_date_period=="mmean"){currentDate.setMonth(11);currentDate.setDate(31);currentDate.setUTCDate(currentDate.getUTCDate()-range_daily)}else{currentDate.setMonth(11);currentDate.setDate(1);
currentDate.setUTCMonth(currentDate.getUTCMonth()-range_monthly)}for(var d=0;d<=e;d++){b[d]=$.datepicker.formatDate(m,currentDate);var k=$.datepicker.formatDate("yy-mm-dd",currentDate);if(k in g){l[d]=g[k]}else{l[d]=-1}if(chosen_date_period=="daily"||chosen_date_period=="dmean"||chosen_date_period=="mmean"){currentDate.setUTCDate(currentDate.getUTCDate()+1)}else{currentDate.setUTCMonth(currentDate.getUTCMonth()+1)
}}var h=-1;var j=-1;for(var d=0;d<l.length;d++){if(l[d]!=-1){h=d;break}}for(var d=l.length-1;d>=0;d--){if(l[d]!=-1){j=d;break}}var f;for(var d=h;d<=j;d++){c.push(l[d]);if(chosen_date_period=="daily"||chosen_date_period=="dmean"||chosen_date_period=="mmean"){f=createUTCDate(b[d]);if(f.getDate()==1){n.push($.datepicker.formatDate("d. M y",f))}else{n.push("")}}else{n.push(b[d])}}for(var d=0;d<c.length;
d++){if(c[d]<0){c[d]=0}}return{labels:n,datasets:[{fillColor:$("#chart_style").css("border-top-color"),strokeColor:$("#chart_style").css("border-left-color"),data:c}]}}function export_chartdata(){stationCoords=new OpenLayers.LonLat(lon,lat);if(osm){stationCoords.transform("EPSG:900913","EPSG:4326")}var k=new Date();var j=k.getFullYear()+"-"+("0"+(k.getMonth()+1)).slice(-2)+"-"+("0"+k.getDate()).slice(-2)+" Time "+("0"+k.getHours()).slice(-2)+":"+("0"+k.getMinutes()).slice(-2)+":"+("0"+k.getSeconds()).slice(-2);
var l=Object.keys(request_results).map(function(d){return request_results[d]});var c=$("input[name=parameter]:checked").parent().find(".radio_label").text();csvData=new Array();csvData.push("WATER QUALITY REPORT");csvData.push("  Generated at: "+j);csvData.push("  Parameter: "+c);csvData.push("  Unit: "+get_unit(chosen_parameter));csvData.push("  Product: eoWater (satellite based)\n\n");csvData.push("Region: "+$("#area_list option:selected").text());
csvData.push("Station lat/lon: "+stationCoords.lat.toFixed(5)+" / "+stationCoords.lon.toFixed(5));csvData.push("Year: "+chosen_time.substring(0,4));csvData.push("  Median:          "+math.median(l).toFixed(2));csvData.push("  Mean:            "+math.mean(l).toFixed(2));csvData.push("  Minimum value:   "+math.min(l).toFixed(2));csvData.push("  Bottom quintile: "+math.quantileSeq(l,0.2).toFixed(2));csvData.push("  Top quintile:    "+math.quantileSeq(l,0.8).toFixed(2));
csvData.push("  Maximum value:   "+math.max(l).toFixed(2)+"\n\n");if(c==="Chlorophyll-a"){var f=calcTrophicalstateVals(l);var e=getTrophicalStateClassesPercent(f);var b="";var m=-Infinity;for(var n in e){if(e.hasOwnProperty(n)){if(e[n]>m){m=e[n];b=n}}}csvData.push("Trophic State Index (according to Carlson 1977): "+b);csvData.push("  Oligotrophic:   "+e.Oligotrophic.toFixed(2)+"%");csvData.push("  Mesotrophic:    "+e.Mesotrophic.toFixed(2)+"%");
csvData.push("  Eutrophic:      "+e.Eutrophic.toFixed(2)+"%");csvData.push("  Hypereutrophic: "+e.Hypereutrophic.toFixed(2)+"%\n\n")}csvData.push("(c) UNESCO, IIWQ World Water Quality Portal, www.worldwaterquality.org");csvData.push("Data products, analysis and web application powered by EOMAP GmbH & Co.KG, Germany, www.eomap.com");csvData.push("Data sources: eoWater products generated from satellite sensors: Sentinel 2a, Landsat-8, Landsat-7\n\n\n");
csvData.push("Single measures:");csvData.push("Date (YYYY-MM-DD); Value");for(i in request_results){csvData.push(i+"; "+request_results[i].toFixed(2))}var h="data.txt";var g=csvData.join("\n");g=g.replace(/([^\r])\n/g,"$1\r\n");blob=new Blob([g],{type:"text/csv;charset=utf8;"});link=document.createElement("a");if(link.download!==undefined){link.setAttribute("href",window.URL.createObjectURL(blob));
link.setAttribute("download",h)}else{if(navigator.msSaveBlob){navigator.msSaveBlob(blob,h)}else{alert("Download is not supported by your browser.")}}link.innerHTML="Export to CSV";document.body.appendChild(link);link.click()}function calcTrophicalstateVals(c){var b=new Array();for(var d=0;d<c.length;d++){b.push(30.6+9.81*Math.log(c[d]))}return b}function getTrophicalStateClassesPercent(j){var c=j.length;
var b=0;var f=0;var g=0;var e=0;for(var d=0;d<c;d++){var k=j[d];if(k<40){b+=1}else{if(k>=40&&k<50){f+=1}else{if(k>=50&&k<70){g+=1}else{e+=1}}}}var h={};h.Oligotrophic=b/c*100;h.Mesotrophic=f/c*100;h.Eutrophic=g/c*100;h.Hypereutrophic=e/c*100;return h}function getMaxDayOfMonth(c,b){if(c==1||c==3||c==5||c==7||c==8||c==10||c==12){return 31}else{if(c!=2){return 30}else{if(b%4==0){if(b==2100){return 28}else{return 29
}}}}}function show_graph(j){var e=document.getElementById("eomap_chart");var d=e.getContext("2d");d.clearRect(0,0,e.width,e.height);var h=processChartData(j);var c=$("#eomap_chart").parent();var f=$("#chart_dialog");var g=$(c).width();var b=f.outerHeight(true)-f.find("#chart_header").outerHeight(true)-4;e.width=g;e.height=b;e.style.width=g+"px";e.style.height=b+"px";graph=new Chart(d).Bar(h,{scaleGridLineColor:$("#chart_style").css("border-bottom-color"),scaleLineColor:$("#chart_style").css("border-right-color"),scaleFontColor:$("#chart_style").css("color"),scaleFontFamily:$("#chart_style").css("font-family"),scaleFontSize:parseInt($("#chart_style").css("font-size").replace("px","")),chartBackground:$("#chart_style").css("background-color"),scaleShowVerticalLines:false,responsive:false,showTooltips:false})
}function plot_turbidity(){if(!loading_average&&chosen_parameter!=="owd"){if(!date_available){alert("No date available")}else{if(feature_counter==0){alert("Set a valid station first.")}else{if(chosen_time&&lat&&lon){$("#chart_dialog").show({duration:1000,complete:function(){show_graph(request_results);chart_results=request_results;window.addEventListener("orientationchange",orientationChange,false)
}})}}}}}function orientationChange(){clear_charts();show_graph(chart_results)}function decode_hab(b){if(b>=95.5&&b<100.5){return 0}else{if(b>=100.5&&b<102.5){return 20}else{if(b>=102.5&&b<105.5){return 50}else{if(b>=105.5){return 90}}}}}function decode_tur_8bit(b){return Math.pow(10,(b-1)/50)/10}function decode_abs_8bit(b){return Math.pow(10,(b-1)/75)/10}function turbidity_to_sd(b){return Math.exp(5.3/(b+1.484))-0.7
}function set_loading_average(){loading_average=true}function reset_loading_average(){loading_average=false}function set_loading_aoi(){loading_aoi=true}function reset_loading_aoi(){loading_aoi=false}function get_unit(b){if(b=="tur"){return"FTU"}else{if(b=="chl"){return String.fromCharCode(181)+"g/l"}else{if(b=="vis"||b=="owd"||b=="sec"||b=="z90"){return"m"}else{if(b=="hab"){return"%"}else{if(b=="abs"||b=="sia"||b=="soa"||b=="cdm"){return"1/m"
}else{if(b=="sst"){return"Â°C"}}}}}}}function get_date_from_jd(b){jd=b.toString().substring(2,5);jdyear="20"+b.toString().substring(0,2);a=new Date(jdyear+"-01-01");a.setDate(a.getDate()+(Number(jd)-1));return $.datepicker.formatDate("dd-mm-yy",a)}function get_time(b){time_resolution=5;t_str=b.toString();t=t_str.substring(0,t_str.length-2);hour=Math.floor((Number(t)*5)/60);min=Number(t)*time_resolution-(hour*60);
if(hour<10){hour="0"+hour.toLocaleString()}if(min<10){min="0"+min.toLocaleString()}time=hour+":"+min;return time}function setup_map_control(){$("#zoom_in").on("click",function(){if(!zoom_in){rectangle_control.deactivate();station_control.deactivate();zoom_out=false;zoom_in=true;unselect_buttons(this);select_button(this,true)}});$("#zoom_out").on("click",function(){if(!zoom_out){rectangle_control.deactivate();
station_control.deactivate();zoom_in=false;zoom_out=true;unselect_buttons(this);select_button(this,true)}});$("#move").on("click",function(){rectangle_control.deactivate();station_control.deactivate();zoom_in=false;zoom_out=false;unselect_buttons(this);select_button(this,true)});$("#station").on("click",function(){if(!station_control.active){rectangle_control.deactivate();zoom_in=false;zoom_out=false;
station_control.activate();unselect_buttons(this);select_button(this,true)}})}function select_button(b,c){if(c){$(b).addClass("selected");$(".top_menu_label."+$(b).attr("id")).addClass("selected")}if(!$(b).attr("src").match("_sel.png$")){var d=$(b).attr("src").match(/[^\.]+/)+"_sel.png";$(b).attr("src",d)}}function unselect_button(b,c){if(c){$(b).removeClass("selected");$(".top_menu_label."+$(b).attr("id")).removeClass("selected")
}if($(b).attr("src").match("_sel.png$")){var d=$(b).attr("src").replace("_sel","");$(b).attr("src",d)}}function unselect_buttons(b){$(".top_panel_right img").each(function(){unselect_button(this,true);if(this!=b){$(".top_menu_label."+$(this).attr("id")).animate({opacity:0},250)}})}function clearButtonLabels(b){$(".top_panel_right img").each(function(){if(this!=b){$(".top_menu_label."+$(this).attr("id")).animate({opacity:0},250)
}})}function setup_welcome_dialog(){if(!$.cookie("dialog_displayed")){$("#welcome_dialog").show();$.cookie("dialog_displayed",true,{expires:20*365})}$("#dialog_close").click(function(){$("#welcome_dialog").hide(1000)});$("#registration").submit(function(c){c.preventDefault();$("#welcome_dialog").hide(1000);var b=$(this).attr("action");$.ajax({type:"POST",url:b,data:$(this).serialize()})})}function setup_welcome_dialog_unesco(){if(!$.cookie("dialog_displayed")){$("#info_dialog").show()
}$(".dontshow_checkbox").change(function(){$.cookie("dialog_displayed",true,{expires:20*365})});$("#dialog_close").click(function(){$("#info_dialog").hide(1000)})}function clear_charts(){for(citem in Chart.instances){delete Chart.instances[citem]}}function setup_chart_dialog(){$("#chart_close").click(function(){$("#chart_dialog").hide(1000);clear_charts();chart_results="";window.removeEventListener("orientationchange",orientationChange)
});$("#export_button").click(export_chartdata)}function clickChartButton(){clear_charts();if(chosen_parameter!=="owd"){$("#chart_heading").text($("input[name=parameter]:checked").parent().find(".radio_label").text()+"    "+chosen_time.substring(0,4));plot_turbidity()}}function enableChart(){$("#chart_button").off("click");$("#chart_button_m").off("click");$("#chart_button").click(clickChartButton);
$("#chart_button_m").click(clickChartButton);$("#chart_button").removeClass("disabled");$("#chart_button_m").removeClass("disabled")}function disableChart(){$("#chart_button").off("click");$("#chart_button_m").off("click");$("#chart_button").addClass("disabled");$("#chart_button_m").addClass("disabled")}function updateMapHeading(){var c=$("input[name=parameter]:checked").parent().find(".radio_label").text();
var b=(chosen_date_period=="daily"||chosen_date_period=="dmean"||chosen_date_period=="mmean")?"MM dd, yy ":"M yy";if(chosen_time){c+=", ";if(chosen_date_period=="monthly"){c+="Various Dates"}else{c+=$.datepicker.formatDate(b,new Date(chosen_time))}}$(".current_date_param").stop().animate({opacity:0},500,function(){$(this).text(c).animate({opacity:1},500)})}function setupTopMenuLabels(){$(".top_menu_icon").mouseenter(function(){if(!$(this).hasClass("selected")){select_button(this,false);
$(this).css("opacity",0.6);$(this).stop().animate({opacity:1},250);$(".top_menu_label."+$(this).attr("id")).css("display","inline");$(".top_menu_label."+$(this).attr("id")).stop().animate({opacity:1},250)}});$(".top_menu_icon").mouseleave(function(){if(!$(this).hasClass("selected")){$(this).stop().animate({opacity:0.6},250,function(){$(this).css("opacity",1);unselect_button(this,false)});$(".top_menu_label."+$(this).attr("id")).stop().animate({opacity:0},250).promise().always(function(){$(this).css("display","none")
})}})}$(function(){map_width=document.getElementById("map").offsetWidth;map_height=document.getElementById("map").offsetHeight;setup_map_control();init();setup_welcome_dialog_unesco();setup_chart_dialog();setupTopMenuLabels();$("#hidepanel_button").click(function(){$("#control_panel").hide(1000);$("#hidepanel_button").hide(1000);$("#showpanel_button").show(1000);$("#state_info").show(1000)});$("#showpanel_button").click(function(){$("#control_panel").show(1000);
$("#showpanel_button").hide(1000);$("#state_info").hide(1000);$("#hidepanel_button").show(1000)});$(document).tooltip();$("#help").click(function(){$("#help_dialog").show("slow")});$("#help2").click(function(){$("#help_dialog").show("slow")});$("#help_close").click(function(){$("#help_dialog").hide("slow")});$("#regioninfo, #regioninfo_welcome").click(function(){$("#regioninfo_dialog").show("slow")
});$("#regioninfo_close, #regioninfo_welcome_close").click(function(){$("#regioninfo_dialog").hide("slow")});$("#disclaimer").click(function(){$("#disclaimer_dialog").show("slow")});$("#disclaimer_close").click(function(){$("#disclaimer_dialog").hide("slow")});$("input[type=radio][name=parameter]").change(function(){$("#chart_dialog").hide(1000);update_parameter(this);if(chosen_region){$.each(areas,function(b,c){if(c.name==chosen_region){if(c.parameters[chosen_parameter]&&c.parameters[chosen_parameter].palstyle){$("#legend").css("background-image","url(/pic/legend_"+chosen_parameter+"_"+c.parameters[chosen_parameter].palstyle+".png)")
}else{$("#legend").css("background-image","url(/pic/legend_"+chosen_parameter+".png)")}}})}else{$("#legend").css("background-image","url(/pic/legend_"+chosen_parameter+".png)")}});$(".shallow_checkbox").change(function(){load_date_and_bbox(true)});$("input[type=radio][name=date_period]").change(function(){chosen_date_period=$(this).val();load_date_and_bbox(true)});$("#date_list").change(function(){update_date(this)
});$("#area_list").change(function(){update_region(this.value)});$("#next_button").click(function(){$("#date_list :selected").prev().prop("selected",true);chosen_time=$("#date_list :selected").val();updateMapHeading();$.each(areas,function(b,c){if(chosen_region&&c.name==chosen_region){update_map(c)}});get_feature()});$("#prev_button").click(function(){$("#date_list :selected").next().prop("selected",true);
chosen_time=$("#date_list :selected").val();updateMapHeading();$.each(areas,function(b,c){if(chosen_region&&c.name==chosen_region){update_map(c)}});get_feature()});if(chosen_parameter=="owd"){disableChart()}});
